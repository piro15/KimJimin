{% extends "layout.html"%}
{% load static %}

{% block content %}
<div class="d-flex flex-column align-items-center ">
    {%for post in posts %}
    <div class="post_{{ post.id }} col-9 p-3 m-2 d-flex justify-content-center border border-secondary rounded-lg" >
        <div class="d-flex align-items-center"><img class="rounded-lg" src="{{ post.image.url }}" style="max-width: 100%;"/></div>
        <div class="col-6">
            <div class="text-center"><a href="{% url 'main:post_detail' post.pk%}"><h6 class="text-dark">{{ post.title }}</h6></a></div>
            <hr>
            <div>{{ post.content }}</div>
            <hr>
            <div>ÎåìÍ∏Ä</div>
            <hr>
            <div class="comments">
                {%for comment in post.comment_set.all %}
                    <div class="comment_{{ comment.id }} d-flex justify-content-between">
                        {{comment.content}}
                        <button class="btn btn-outline-secondary btn-sm" onclick="deleteComment({{ comment.id }})">ÏÇ≠Ï†ú</button>
                    </div>
                {%endfor %}
            </div>
            <hr>
            {% if post.like %}
                <div class="post_like" onclick="onClickLike({{ post.id }},'like')">‚ù§Ô∏è</div>
            {% else %}
                <div class="post_dislike" onclick="onClickLike({{ post.id }},'dislike')">ü§ç</div>
            {% endif %}
            <hr>
            <div class="d-flex justify-content-between">
                <input class="comment col-10" type="text" placeholder="ÎåìÍ∏Ä Îã¨Í∏∞ ..." style="border:none;">
                <button class="btn btn-outline-secondary btn-sm" onclick="newComment({{ post.id }})">Í≤åÏãú</button>
            </div>
        </div>
    </div>
    <hr>
    {% endfor %}
</div>
{% endblock %}

{% block extra %}
<script>
    const requestLike = new XMLHttpRequest();//ajax ÏöîÏ≤≠Ïóê ÌïÑÏöîÌïú Î©îÏÑúÎìúÍ∞Ä Îã¥Í≤®ÏûàÍ∏∞ ÎïåÎ¨∏Ïóê Í∞ùÏ≤¥ Î∂àÎü¨ Ïò® Í≤É. 

    const onClickLike = (id, type) => {//Í≤åÏãúÍ∏ÄÏùò ÏïÑÏù¥ÎîîÏôÄ likeÏù∏ÏßÄ DislikeÏù∏ÏßÄ. 
        const url ='/like_ajax/';//Ïó¨Í∏∞Î°ú ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ∏Îã§. 
        requestLike.open("POST", url, true);//POSTÎ∞©ÏãùÏúºÎ°ú Ï†ÄÍ∏∞Ïóê Î≥¥ÎÇ¥Í≤†Îã§.
        requestLike.setRequestHeader(//Í±∞Ïùò Î≥ÄÌôîÏóÜÏù¥ Ìï≠ÏÉÅ ÎòëÍ∞ôÏù¥ Ïì¥Îã§. 
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestLike.send(JSON.stringify({id:id, type:type}));//ÌÇ§:Í∞í ÌòïÌÉúÏùò Î∞∞Ïó¥.
    };

    const likeHandleResponse = () => {
        if(requestLike.status < 400) {//Ï†ïÏÉÅÏù¥Î©¥
            const {id, type} =JSON.parse(requestLike.response);//ÌÇ§:Í∞í ÌòïÌÉúÏùò Î∞∞Ïó¥ Î∞õÏïÑÏò§Í∏∞
            const element = document.querySelector(`.post_${id} .post_${type}`);
            if (element.innerHTML=='ü§ç'){
                element.innerHTML='‚ù§Ô∏è';
            }else{
                element.innerHTML='ü§ç';
            }
        }
    }
    //readystateÍ∞Ä Î≥ÄÌï† Îïå ÎßàÎã§ Ï≤òÎ¶¨Ìï¥Îã¨Îùº
    requestLike.onreadystatechange = () => {
        if (requestLike.readyState === XMLHttpRequest.DONE) {//Í∞íÎßå Í∞ôÏùÄÏßÄ ÌÉÄÏûÖÎèÑ Í∞ôÏùÄÏßÄ Ï∞®Ïù¥.
            likeHandleResponse();
        }
    } 


//ÏÉà ÎåìÍ∏Ä
    const requestComment = new XMLHttpRequest();

    const newComment = (id) => {
        const url ='/new_comment/';
        requestComment.open("POST", url, true);
        requestComment.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        const content = document.querySelector(`.post_${id} .comment`).value;
        requestComment.send(JSON.stringify({id:id, content:content}));
    };

    const commentHandleResponse = () => {
        if(requestComment.status < 400) {
            const {id, content} =JSON.parse(requestComment.response);
            const element = document.querySelector(`.post_${id} .comments`);
            element.innerHTML += `<div class="comment_{{ comment.id }} d-flex justify-content-between">
                ${content}
                    <button class="btn btn-outline-secondary btn-sm" onclick="deleteComment({{ comment.id }})">ÏÇ≠Ï†ú</button>
                </div>`;
        }
    }

    requestComment.onreadystatechange = () => {
        if (requestComment.readyState === XMLHttpRequest.DONE) {
            commentHandleResponse();
        }
    } 


//ÎåìÍ∏Ä ÏÇ≠Ï†ú
    const requestDelComment = new XMLHttpRequest();

    const deleteComment = (id) => {
        const url ='/delete_comment/';
        requestDelComment.open("POST", url, true);
        requestDelComment.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestDelComment.send(JSON.stringify({id:id}));
    };

    const commentDelHandleResponse = () => {
        if(requestDelComment.status < 400) {
            const {id, content} =JSON.parse(requestDelComment.response);
            const element = document.querySelector(`.comments .comment_${id}`);
            //https://hianna.tistory.com/484
            element.remove()//Ïù¥Î†áÍ≤åÎßå Ïì∞Î©¥ ÏÉàÎ°ú ÏûëÏÑ±ÌïòÍ≥† ÏÉàÎ°úÍ≥†Ïπ®Ìïú Ï†Å ÏóÜÎäî ÎåìÍ∏ÄÏùÄ ÏÇ≠Ï†úÍ∞Ä ÏïàÎêúÎã§. ÏÉàÎ°úÍ≥†Ïπ® ÌïòÍ≥†ÏÑúÏïº ÎêúÎã§.
        }
    }

    requestDelComment.onreadystatechange = () => {
        if (requestDelComment.readyState === XMLHttpRequest.DONE) {
            commentDelHandleResponse();
        }
    } 
</script>
{% endblock %}